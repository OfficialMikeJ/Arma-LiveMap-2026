name: Build Arma Reforger Map Desktop App

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.100.030)'
        required: false
        type: string
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        cd desktop_app
        pip install -r requirements.txt
        pip install pyinstaller requests
    
    - name: Extract version from code
      id: get_version
      shell: bash
      run: |
        cd desktop_app
        VERSION=$(python -c "import re; content = open('gui/main_window.py', encoding='utf-8').read(); print(re.search(r'VERSION = \"(.+?)\"', content).group(1))")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Detected version: $VERSION"
    
    - name: Build executable with PyInstaller
      run: |
        cd desktop_app
        pyinstaller --name "ArmaReforgerMap" --windowed --onedir main.py
    
    - name: Copy config files to dist
      run: |
        xcopy /E /I desktop_app\config desktop_app\dist\ArmaReforgerMap\config
    
    - name: Copy documentation to dist
      run: |
        copy desktop_app\README.md desktop_app\dist\ArmaReforgerMap\
        copy desktop_app\CHANGELOG.md desktop_app\dist\ArmaReforgerMap\
        if exist desktop_app\docs\QUICKSTART.md copy desktop_app\docs\QUICKSTART.md desktop_app\dist\ArmaReforgerMap\
    
    - name: Create portable release package
      run: |
        mkdir release
        xcopy /E /I desktop_app\dist\ArmaReforgerMap release\ArmaReforgerMap
    
    - name: Create ZIP archive
      run: |
        cd release
        powershell Compress-Archive -Path ArmaReforgerMap -DestinationPath ArmaReforgerMap-v${{ steps.get_version.outputs.version }}-Windows-Portable.zip
    
    - name: Upload artifact (Folder)
      uses: actions/upload-artifact@v4
      with:
        name: ArmaReforgerMap-v${{ steps.get_version.outputs.version }}-Windows
        path: release/ArmaReforgerMap/
        retention-days: 30
    
    - name: Upload artifact (ZIP)
      uses: actions/upload-artifact@v4
      with:
        name: ArmaReforgerMap-v${{ steps.get_version.outputs.version }}-Windows-ZIP
        path: release/ArmaReforgerMap-v${{ steps.get_version.outputs.version }}-Windows-Portable.zip
        retention-days: 30
    
    - name: Create GitHub Release
      if: github.event.inputs.create_release == 'true' || startsWith(github.ref, 'refs/tags/')
      shell: bash
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        RELEASE_VERSION: ${{ steps.get_version.outputs.version }}
        CHANGELOG_PATH: desktop_app/CHANGELOG.md
        ASSET_PATH: release/ArmaReforgerMap-v${{ steps.get_version.outputs.version }}-Windows-Portable.zip
      run: |
        cd desktop_app
        python scripts/create_github_release.py
